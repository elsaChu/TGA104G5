<!DOCTYPE html>
<html>

<head>
  <title>TICK IT</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="keywords"
    content="Login form web template, Sign up Web Templates, Flat Web Templates, Login signup Responsive web template, Smartphone Compatible web template, free webdesigns for Nokia, Samsung, LG, SonyErricsson, Motorola web design" />
  <!-- <link href="css/OrganizeSelectAllResult.css" rel="stylesheet" type="text/css" media="all" /> -->
  <!-- Custom Theme files -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link href="./css/OrganizeSelectAllResult.css" rel="stylesheet" type="text/css" media="all" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>

 
</head>

<body>
  <div class="login">
    <h2>廠商註冊</h2>
    <div class="login-top">
      <h1>搜尋</h1>
      <div>
        <div class="searchOrganizerDiv">
          <form action="#" name="OrganizerSelectAllForm" method="POST">
          <h1></h1>
            <div class="forgot row">
              <div class="searchBarDiv col-10">
                <input type="text" placeholder="搜尋廠商(searchKeyword)" name="searchKeyword" class="searchBar">
              </div>
              <div class="col-2">
                <input type="button" value="搜索" />
              </div>
              <input type="file" id="the_file" accept="image/*" multiple>
               <ul class="picture_list"></ul>
            </div>
            <input type="hidden" name="testHidden" value="<%=request.getContextPath()%>">
          </form>
     
          <div class="organizerSearchBy">
            <!-- <input type="text" placeholder="SearchByOrganizerName" /> -->
            <!-- <label for="">Order By: </label>
            <select name="" id="">
              <option value="">Organizer Name</option>
              <option value="">Organizer UserName</option>
              <option value="">Organizer 註冊日期</option>
            </select> -->
            <!-- <input type="text" placeholder="公司登記地址" /> -->
          </div>
        </div>
      </div>

      
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>

      $(function(){
        $("#the_file").on("change", function(e){
          // 清空
          $("ul.picture_list").html("");
          //console.log("here");
          //console.log(this);
          var that = this; // 將 this 用 that 來替代，底下程式會用到
          // 跑每個使用者選的檔案
          for (let i = 0; i < this.files.length; i++) {
            let reader = new FileReader(); // 用來讀取檔案
            reader.readAsDataURL(this.files[i]); // 讀取檔案
            reader.addEventListener("load", function (e) {
              console.log("load 事件");
              //console.log("here2");
              //console.log(this);
              // 加進節點
              $("ul.picture_list").append(`
                <li data-index="${i}">
                  <img class="preview" src="${reader.result}">
                  <div class="progressbar"><span class="progress" style="width: 0%;"></span></div>
                </li>
              `);
              // 這裡實際將檔案傳送出去：ajax 技術
              let form_data = new FormData();
              form_data.append('the_file', that.files[i]);
              $.ajax({
                url: "https://notes.webmix.cc/html5_tutorial/file/file_receive.php",
                type: "POST",
                data: form_data,
                dataType: "json",
                
                contentType: false,
                cache: false,
                processData:false,

                xhr: function() {
                  console.log("嗨 xhr()");

                  //var myXhr = $.ajaxSettings.xhr();
                  let myXhr = new XMLHttpRequest();
                  if(myXhr.upload){

                    myXhr.upload.addEventListener('progress', function(evt) {
                      console.log("progress 事件觸發，印出事件物件：");
                      console.log(evt)
                      
                      if (evt.lengthComputable) {
                        var loaded = (evt.loaded / evt.total);
                        if (loaded <= 1) {
                          //console.log(evt.loaded / evt.total)
                          var percent = loaded * 100;
                          console.log("進度：" + percent + "%");

                          // 找到對應的進度條
                          $("ul.picture_list li[data-index=" + i + "]").find("span.progress").attr("style", "width: " + percent + "%;");
                        }
                      }

                    });
                  }
                  return myXhr;

                },

                success: function(data_obj) { // 從伺服器回傳的資料
                  console.log("success");
                  alert("傳送完成");
                  console.log(data_obj);

                }
              });

            });


          }

        });
      });
    </script>
     <style>
      img.preview{
        width: 200px;
      }
      ul{
        list-style: none;
        margin: 0;
        padding: 0;
      }
      ul > li{
        display: inline-block;
        vertical-align: top;
      }

      div.progressbar{
        height: 20px;
        background-color: #e9ecef;
        border-radius: 8px;
        position: relative;
        overflow: hidden;
        margin-bottom: 30px;
      }
      div.progressbar > span.progress{
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        box-sizing: border-box;
        background-color: #007bff;
      }
    </style>
    <script>
      //以下是fetch() ajax: 
      // var fetch_url = "https://notes.webmix.cc/ajax/teach/simple.php";
      // //var fetch_url = "https://notes.webmix.cc/ajax/teach/simple_500.php";
      // //var fetch_url = "http://127.0.0.1:5500/ajax/no_file.html";
      // //var fetch_url = "https://notes.webmix.cc/ajax/teach/simple_no.php";
      
      // fetch(fetch_url).then(function(response){ // 接收到回傳的物件(尚未取得真正的資料)
    
      //   console.log(response);
      //   if(response.ok){ // 如果正確取得資料，沒有發生錯誤
      //     return response.json(); // 將取得的資料，再使用 .json() 解析資料
      //   }
      //   throw new Error(response.statusText); // 會執行下方的 catch 區塊程式
    
      // }).then(function(data){ // 這裡真的取得資料：data
      //   console.log("成功取得資料");
      //   console.log(data);
      // }).catch(function(error){ // 發生任何錯誤，就會執行 catch 裡的程式
      //   console.log("錯誤資訊");
      //   console.log(error); // 這裡取得錯誤資訊：error
      // });
      
      // console.log("非同步，故這裡會先印出來");
    
 
    </script>
</body>

</html>